<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Super Burger Time</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var config = {
        type: Phaser.AUTO,
        width: 1600,
        height: 900,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 600 },
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var game = new Phaser.Game(config);

    function preload ()
    {
        this.load.image('background', 'assets/final/background.png');
        this.load.image('ground', 'assets/final/platform6.png');
        this.load.image('platform1', 'assets/final/platform1.png');
        this.load.image('platform2', 'assets/final/platform2.png');
        this.load.image('platform3', 'assets/final/platform3.png');
        this.load.image('platform4', 'assets/final/platform4.png');
        this.load.image('platform5', 'assets/final/platform5.png');
        this.load.image('ladder1', 'assets/final/ladder1.png');
        this.load.image('ladder2', 'assets/final/ladder2.png');
        this.load.image('ladder3', 'assets/final/ladder3.png');
        this.load.image('ladder4', 'assets/final/ladder4.png');
        this.load.image('ladder5', 'assets/final/ladder5.png');
        this.load.image('player', 'assets/front.png');
        this.load.image('enemy', 'assets/werewolf.png');
        this.load.image('head', 'assets/body/newhead.png');
        this.load.image('arms', 'assets/body/newarms.png');
        this.load.image('torso', 'assets/body/newtorso.png');
        this.load.image('legs', 'assets/body/newlegs2.png');
        //this.load.spritesheet('test', 'assets/luchador-win', {frameWidth: 280, frameHeight: 320});
        this.load.spritesheet('vat', 'assets/DryRun/vat.png', {frameWidth: 142, frameHeight: 179});
        this.load.spritesheet('scientist-left', 'assets/scientist-walk left.png', {frameWidth: 52, frameHeight: 110});
        this.load.spritesheet('scientist-right', 'assets/scientist-walk right.png', {frameWidth: 52, frameHeight: 110});
        this.load.spritesheet('scientist-up', 'assets/scientist-walk up.png', {frameWidth: 52, frameHeight: 110});
        this.load.spritesheet('scientist-down', 'assets/scientist-walk down.png', {frameWidth: 52, frameHeight: 110});
        this.load.image('vatliquid', 'assets/DryRun/liquid.png');
        this.load.image('menu', 'assets/DryRun/menu.png');
    }

    var ground;
    var platforms;
    var vats;
    var enemies;
    var ladders;
    var player = null;
    var isPlayerDead;
    var onladder;
    var bodyparts;
    var onBodypart;
    var vatscreens;
    var vatbottom;
    var menu;

    function buildplatforms () {
        platforms.create(375, 510, 'platform5');
        platforms.create(1125, 450, 'platform4');
        platforms.create(1225, 320, 'platform3');
        platforms.create(375, 320, 'platform2');
        platforms.create(800, 190, 'platform1');
    }

    function buildladders () {
        ladders.create(225, 241, 'ladder1');
        ladders.create(225, 541, 'ladder2');
        ladders.create(610, 383, 'ladder3');
        ladders.create(990, 449, 'ladder4');
        ladders.create(1375, 308, 'ladder5');
    }

    function buildbody () {
        bodyparts.create(415, 595, 'legs').name = 'legs';
        bodyparts.create(800, 595, 'legs').name = 'legs';
        bodyparts.create(1185, 595, 'torso').name = 'torso';
        bodyparts.create(415, 485, 'torso').name = 'torso';
        bodyparts.create(1185, 295, 'arms').name = 'arms';
        bodyparts.create(415, 165, 'head').name = 'head';
        bodyparts.create(800, 165, 'head').name = 'head';
        bodyparts.create(1185, 165, 'head').name = 'head';
    }

    function buildEnemies(){
        enemies.create(500, 550, 'enemy').setScale(.75).setCollideWorldBounds(true);
    }

    function buildVats() {
        vats.create(800, 740, 'vatliquid');
        vats.create(415, 740, 'vatliquid');
        vats.create(1185, 740, 'vatliquid');
    }

    function buildVats2() {
        vatscreens.create(800, 740, 'vat');
        vatscreens.create(415, 740, 'vat');
        vatscreens.create(1185, 740, 'vat');
    }

    function create ()
    {
        this.physics.world.setBounds(100, 64, 1403, 765);
        this.add.image(800, 450, 'background');
        ground = this.physics.add.staticGroup();
        ground.create(800, 620, 'ground');
        vatbottom = this.physics.add.staticGroup();
        vatbottom.create(800, 810, 'ground', null, null, false);
        //ground.create(640, 825, 'ground').setScale(3.5).refreshBody();

        platforms = this.physics.add.staticGroup();
        buildplatforms();
        ladders = this.physics.add.staticGroup();
        buildladders();
        vats = this.physics.add.staticGroup();
        buildVats();

        //parts will contain variables: steppedOn, falling, hasOverlapped, squished (i.e. has been crushed by another part)
        bodyparts = this.physics.add.group();
        buildbody();

        //enemy setup
        //enemies will contain variables: dead, onladder
        enemies = this.physics.add.group();
        buildEnemies();

        //player setup
        player = this.physics.add.sprite(900, 550, 'player').setScale(.75);
        player.setBounce(0.0);
        player.setCollideWorldBounds(true);
        this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('scientist-left', {start: 0, end: 3}),
            frameRate: 10,
            repeat: -1
        });
        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('scientist-right', {start: 0, end: 3}),
            frameRate: 10,
            repeat: -1
        });
        this.anims.create({
            key: 'up',
            frames: this.anims.generateFrameNumbers('scientist-up', {start: 0, end: 3}),
            frameRate: 10,
            repeat: -1
        });
        this.anims.create({
            key: 'down',
            frames: this.anims.generateFrameNumbers('scientist-down', {start: 0, end: 3}),
            frameRate: 10,
            repeat: -1
        });
        this.anims.create({
            key: 'still',
            frames: this.anims.generateFrameNumbers('scientist-down', {start: 0, end: 0}),
            frameRate: 10,
            repeat: -1
        });

        vatscreens = this.physics.add.staticGroup();
        buildVats2();
        this.anims.create({
            key: 'bubble',
            frames: this.anims.generateFrameNumbers('vat', {start: 0, end: 15}),
            frameRate: 10,
            repeat: -1
        });

        menu = this.add.image(800, 450, 'menu');
        menu.visible = true;

        //collisions
        this.physics.add.collider(player, ground);
        this.physics.add.collider(player, platforms, null, checkUp);
        this.physics.add.overlap(player, ladders, checkoverlap);
        this.physics.add.overlap(player, bodyparts, checkPartOverlap);
        this.physics.add.overlap(player, enemies, null, checkPlayerDeath);
        this.physics.add.collider(enemies, ground, null, enemyFalling);
        this.physics.add.collider(enemies, platforms, null, checkUpEnemy);
        this.physics.add.overlap(enemies, ladders);
        this.physics.add.collider(bodyparts, platforms, null, isFalling);
        this.physics.add.collider(bodyparts, ground, null, fallIntoVat);
        this.physics.add.collider(bodyparts, bodyparts, null, inVat);
        this.physics.add.overlap(bodyparts, bodyparts, partsOverlap);
        this.physics.add.overlap(bodyparts, enemies, hitEnemy);
        this.physics.add.collider(bodyparts, vatbottom);
        this.physics.add.collider(enemies, vatbottom);

        cursors = this.input.keyboard.createCursorKeys();
        this.physics.pause();
    }

    function checkoverlap() {
        onladder = true;
    }

    function checkPlayerDeath(player, enemy){
        if (player.body.bottom == enemy.body.bottom)
            isPlayerDead = true;
    }



    function checkPartOverlap(player, part){
        onBodypart = true;
        part.steppedOn = true;
        part.squished = false;
    }

    function isFalling(part){
        if(part.steppedOn){
            return false;
        }
        else{
            return true;
        }
    }

    function fallIntoVat(part) {
        if(part.steppedOn && (part.body.bottom != 766)){
            return false;
        }
        else{
            return true;
        }
    }

    function inVat(part1, part2) {
        if (part1.body.bottom > 616 && part2.body.bottom > 616) {
            return true;
        }
        else {
            return false;
        }
    }

    function checkEnemyOverlap(enemy) {
        enemy.onladder = true;
    }

    function partsOverlap(part1, part2) {
        //only check this once or it'll get both directions on the overlap
        if (part1.falling && !part1.hasOverlapped && !part2.hasOverlapped) {
            part2.steppedOn = true;
            part2.squished = true;
            part1.steppedOn = false;
            part1.squished = false;
            part1.hasOverlapped = part2.hasOverlapped = true;
        }
    }

    function checkUp() {
        if (onladder == true && (player.body.velocity.y < 0 || player.body.velocity.y > 0 )) {
            return false;
        }
        else {
            return true;
        }
    }

    //checks enemy collision with platforms
    function checkUpEnemy(enemy) {
        if ((enemy.onladder == true && (enemy.body.velocity.y < 0 || enemy.body.velocity.y > 0 ) && (enemy.body.bottom != player.body.bottom)) || enemy.dead) {
            return false;
        }
        else {
            return true;
        }
    }

    //checks enemy collision with ground
    function enemyFalling(enemy) {
        if (enemy.dead) {
            return false;
        }
        else {
            return true;
        }
    }

    //checks if enemy has been hit by a part
    function hitEnemy(part, enemy) {
        if (part.falling) {
            enemy.dead = true;
        }
    }

    function resetGame(){
        console.log("reset");
        bodyparts.clear(true);
        enemies.clear(true);

        buildEnemies();
        buildbody();
        player.scene.scene.restart();
    }

    function moveBodyParts(){
        bodyparts.children.each(function(part) {
            if (part.steppedOn) {
                part.setVelocityY(50);
            }
            if (part.body.velocity.y > 0) {
                part.falling = true;
            }
            else {
                part.falling = false;
            }
        }, this);
    }

    function moveEnemies() {
        enemies.children.each(function(enemy) {
            //stop falling off ladder
            if (enemy.onladder && (enemy.body.bottom >= player.body.bottom - 5)) {
                enemy.setGravityY(-600);
            }
            else {
                enemy.setGravityY(600);
            }
            //don't move if dead
            if (enemy.dead) {
                enemy.body.velocity.x = 0;
            }
            //has not yet started moving
            else if (enemy.body.velocity.x == 0 && enemy.onladder == false) {
                if (player.x < enemy.x) {
                    enemy.body.velocity.x = -40;
                }
                else if (player.x > enemy.x) {
                    enemy.body.velocity.x = 40;
                }
            }
            //only change directions if on the same platform, otherwise keep moving
            else if ((player.body.bottom >= enemy.body.bottom - 5) && (player.body.bottom <= enemy.body.bottom + 25)) {
                if (player.x < enemy.x && enemy.body.velocity.x >= 0) {
                    enemy.body.velocity.x = -50;
                }
                else if (player.x > enemy.x && enemy.body.velocity.x <= 0) {
                    enemy.body.velocity.x = 50;
                }

            }
            //player on new level...
            else {
                //just go straight up or down
                if (enemy.onladder == true) {
                    enemy.body.setVelocityX(0);
                    if (player.y < enemy.y) {
                        enemy.body.velocity.y = -50;
                    }
                    else if (player.y > enemy.y) {
                        enemy.body.velocity.y = 50;
                    }
                    if (player.body.bottom == enemy.body.bottom) {
                        enemy.setVelocityY(0);
                    }
                }
            }
        }, this);
    }

    function update ()
    {
        onladder = false;
        onBodypart = false;
        isPlayerDead = false;
        //anything needing to be done to body parts goes here
        bodyparts.children.each(function(part) {
            //don't reset steppedon right away if it just got crushed or it won't fall
            if (part.squished != undefined && part.squished == false)
                part.steppedOn = false;
            //this is a janky quick fix
            if (part.body.bottom == 766) {
                part.steppedOn = false;
                part.falling = false;
            }
        }, this);
        //anything needing to be done to enemies goes here
        enemies.children.each(function(enemy) {
            enemy.onladder = false;
            this.physics.overlap(enemy, ladders, checkEnemyOverlap);
        }, this);
        this.physics.overlap(player, ladders, checkoverlap);
        this.physics.overlap(player, bodyparts, checkPartOverlap);
        this.physics.overlap(player, enemies, checkPlayerDeath);
        if (!this.physics.overlap(bodyparts, bodyparts, partsOverlap)) {
            //if nothing is overlapping reset all overlaps
            bodyparts.children.each(function(part) {
                part.hasOverlapped = false;
            }, this);
        }
        moveEnemies();
        moveBodyParts();
        player.setGravityY(600);
        if (cursors.left.isDown)
        {
            player.setVelocityX(-160);
            if (onladder == true) {
                player.setGravityY(0);
            }
            player.anims.play('left', true);
        }
        else if (cursors.right.isDown)
        {
            player.setVelocityX(160);
            if (onladder == true) {
                player.setGravityY(0);
            }
            player.anims.play('right', true);
        }
        else if (cursors.up.isDown)
        {
            if (onladder == true) {
                player.setVelocityY(-160);
                player.anims.play('up', true);
            }
        }
        else if (cursors.down.isDown)
        {
            if (onladder == true) {
                player.setVelocityY(160);
                player.anims.play('down', true);
            }
        }
        else if (cursors.space.isDown) {
            if (menu.visible) {
                this.physics.resume();
                menu.visible = false;
            }
        }
        else
        {
            player.setVelocityX(0);
            if (onladder) {
                player.setAccelerationY(0);
                player.setVelocityY(0);
                player.setGravityY(-600);
            }
            else
                player.setGravityY(600);
            player.anims.play('still', true);
        }
        if(isPlayerDead){
            resetGame();
        }
        //animations
        vatscreens.children.each(function(screen) {
            screen.anims.play('bubble', true);
        }, this);
    }

</script>

</body>
</html>