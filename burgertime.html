<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Super Burger Time</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var config = {
        type: Phaser.AUTO,
        width: 1280,
        height: 800,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 600 },
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var game = new Phaser.Game(config);

    function preload ()
    {
        this.load.image('background', 'assets/1st playable/background.png');
        this.load.image('ground', 'assets/platform.png');
        this.load.image('platform', 'assets/1st playable/soloplatform.png');
        this.load.image('ladder', 'assets/DryRun/ladders.png');
        this.load.image('player', 'assets/front.png');
        this.load.image('enemy', 'assets/werewolf.png');
        this.load.image('head', 'assets/body/head.png');
        this.load.image('arms', 'assets/body/arms.png');
        this.load.image('torso', 'assets/body/torso.png');
        this.load.image('legs', 'assets/body/legs.png');
        //this.load.spritesheet('test', 'assets/luchador-win', {frameWidth: 280, frameHeight: 320});
        this.load.spritesheet('vat', 'assets/DryRun/vat.png', {frameWidth: 142, frameHeight: 179});
        this.load.spritesheet('scientist-left', 'assets/scientist-walk left.png', {frameWidth: 52, frameHeight: 110});
        this.load.spritesheet('scientist-right', 'assets/scientist-walk right.png', {frameWidth: 52, frameHeight: 110});
        this.load.spritesheet('scientist-up', 'assets/scientist-walk up.png', {frameWidth: 52, frameHeight: 110});
        this.load.spritesheet('scientist-down', 'assets/scientist-walk down.png', {frameWidth: 52, frameHeight: 110});
        this.load.image('vatliquid', 'assets/DryRun/liquid.png');
    }

    var ground;
    var platforms;
    var vat;
    var enemies;
    var ladders;
    var player = null;
    var isPlayerDead;
    var onladder;
    var bodyparts;
    var onBodypart;
    var vatscreen;
    var vatbottom;

    function buildplatforms () {
        //platforms.create(660, 620, 'platform');
        platforms.create(660, 460, 'platform');
        platforms.create(660, 300, 'platform');
        platforms.create(660, 140, 'platform');
    }

    function buildladders () {
        ladders.create(850, 357, 'ladder');
        ladders.create(470, 357, 'ladder');
    }

    function buildbody () {
        bodyparts.create(630, 595, 'legs').name = 'legs';
        bodyparts.create(630, 435, 'torso').name = 'torso';
        bodyparts.create(630, 275, 'arms').name = 'arms';
        bodyparts.create(630, 115, 'head').name = 'head';
    }

    function buildEnemies(){
        enemies.create(500, 550, 'enemy');
    }
    function create ()
    {

        this.add.image(640, 400, 'background');
        ground = this.physics.add.staticGroup();
        ground.create(660, 620, 'platform');
        vatbottom = this.physics.add.staticGroup();
        vatbottom.create(660, 770, 'platform', null, null, false);
        //ground.create(640, 825, 'ground').setScale(3.5).refreshBody();

        platforms = this.physics.add.staticGroup();
        buildplatforms();
        ladders = this.physics.add.staticGroup();
        buildladders();
        vat = this.physics.add.staticGroup();
        vat.create(630, 710, 'vatliquid');

        //parts will contain variables: steppedOn, falling, hasOverlapped, squished (i.e. has been crushed by another part)
        bodyparts = this.physics.add.group();
        buildbody();

        //enemy setup
        //enemies will contain variables: dead, onladder
        enemies = this.physics.add.group();
        buildEnemies();


        //player setup
        player = this.physics.add.sprite(800, 550, 'player');
        player.setBounce(0.0);
        player.setCollideWorldBounds(true);
        this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('scientist-left', {start: 0, end: 3}),
            frameRate: 10,
            repeat: -1
        });
        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('scientist-right', {start: 0, end: 3}),
            frameRate: 10,
            repeat: -1
        });
        this.anims.create({
            key: 'up',
            frames: this.anims.generateFrameNumbers('scientist-up', {start: 0, end: 3}),
            frameRate: 10,
            repeat: -1
        });
        this.anims.create({
            key: 'down',
            frames: this.anims.generateFrameNumbers('scientist-down', {start: 0, end: 3}),
            frameRate: 10,
            repeat: -1
        });
        this.anims.create({
            key: 'still',
            frames: this.anims.generateFrameNumbers('scientist-down', {start: 0, end: 0}),
            frameRate: 10,
            repeat: -1
        });

        vatscreen = this.physics.add.staticSprite(630, 710, 'vat');
        this.anims.create({
            key: 'bubble',
            frames: this.anims.generateFrameNumbers('vat', {start: 0, end: 15}),
            frameRate: 10,
            repeat: -1
        });

        // sprite = this.physics.add.sprite(100, 100, 'test');
        // this.anims.create({
        //     key: 'stand',
        //     frames: this.anims.generateFrameNumbers('test', { start: 0, end: 11 }),
        //     frameRate: 10,
        //     repeat: -1
        // });
        // sprite.setCollideWorldBounds(true);

        //collisions
        this.physics.add.collider(player, ground);
        this.physics.add.collider(player, platforms, null, checkUp);
        this.physics.add.overlap(player, ladders, checkoverlap);
        this.physics.add.overlap(player, bodyparts, checkPartOverlap);
        this.physics.add.overlap(player, enemies, null, checkPlayerDeath);
        this.physics.add.collider(enemies, ground, null, enemyFalling);
        this.physics.add.collider(enemies, platforms, null, checkUpEnemy);
        this.physics.add.overlap(enemies, ladders);
        this.physics.add.collider(bodyparts, platforms, null, isFalling);
        this.physics.add.collider(bodyparts, ground, null, fallIntoVat);
        this.physics.add.collider(bodyparts, bodyparts, null, inVat);
        this.physics.add.overlap(bodyparts, bodyparts, partsOverlap);
        this.physics.add.overlap(bodyparts, enemies, hitEnemy);
        this.physics.add.collider(bodyparts, vatbottom);
        this.physics.add.collider(enemies, vatbottom);

        cursors = this.input.keyboard.createCursorKeys();
    }

    function checkoverlap() {
        onladder = true;
    }

    function checkPlayerDeath(){
        isPlayerDead = true;
    }



    function checkPartOverlap(player, part){
        onBodypart = true;
        part.steppedOn = true;
        part.squished = false;
    }

    function isFalling(part){
        if(part.steppedOn){
            return false;
        }
        else{
            return true;
        }
    }

    function fallIntoVat(part) {
        if(part.steppedOn && (part.body.bottom != 766)){
            return false;
        }
        else{
            return true;
        }
    }

    function inVat(part1, part2) {
        if (part1.body.bottom > 616 && part2.body.bottom > 616) {
            return true;
        }
        else {
            return false;
        }
    }

    function checkEnemyOverlap(enemy) {
        enemy.onladder = true;
    }

    function partsOverlap(part1, part2) {
        //only check this once or it'll get both directions on the overlap
        if (part1.falling && !part1.hasOverlapped && !part2.hasOverlapped) {
            part2.steppedOn = true;
            part2.squished = true;
            part1.steppedOn = false;
            part1.squished = false;
            part1.hasOverlapped = part2.hasOverlapped = true;
        }
    }

    function checkUp() {
        if (onladder == true && (player.body.velocity.y < 0 || player.body.velocity.y > 0 )) {
            return false;
        }
        else {
            return true;
        }
    }

    //checks enemy collision with platforms
    function checkUpEnemy(enemy) {
        if ((enemy.onladder == true && (enemy.body.velocity.y < 0 || enemy.body.velocity.y > 0 )) || enemy.dead) {
            return false;
        }
        else {
            return true;
        }
    }

    //checks enemy collision with ground
    function enemyFalling(enemy) {
        if (enemy.dead) {
            return false;
        }
        else {
            return true;
        }
    }

    //checks if enemy has been hit by a part
    function hitEnemy(part, enemy) {
        if (part.falling) {
            enemy.dead = true;
        }
    }

    function resetGame(){
        console.log("reset");
        bodyparts.clear(true);
        enemies.clear(true);

        buildEnemies();
        buildbody();
    }

    function moveBodyParts(){
        bodyparts.children.each(function(part) {
            if (part.steppedOn) {
                part.setVelocityY(50);
            }
            if (part.body.velocity.y > 0) {
                part.falling = true;
            }
            else {
                part.falling = false;
            }
        }, this);
    }

    function moveEnemies() {
        enemies.children.each(function(enemy) {
            //has not yet started moving
            if (enemy.dead) {
                enemy.body.velocity.x = 0;
            }
            else if (enemy.body.velocity.x == 0 && enemy.onladder == false) {
                if (player.x < enemy.x) {
                    enemy.body.velocity.x = -40;
                }
                else if (player.x > enemy.x) {
                    enemy.body.velocity.x = 40;
                }
            }
            //only change directions if on the same platform, otherwise keep moving
            else if ((player.body.bottom >= enemy.body.bottom - 5) && (player.body.bottom <= enemy.body.bottom + 20)) {
                if (player.x < enemy.x && enemy.body.velocity.x >= 0) {
                    enemy.body.velocity.x = -40;
                }
                else if (player.x > enemy.x && enemy.body.velocity.x <= 0) {
                    enemy.body.velocity.x = 40;
                }

            }
            //player on new level...
            else {
                //just go straight up or down
                if (enemy.onladder == true) {
                    enemy.body.setVelocityX(0);
                    if (player.y < enemy.y) {
                        enemy.body.velocity.y = -50;
                    }
                    else if (player.y > enemy.y) {
                        enemy.body.velocity.y = 50;
                    }
                }
            }
        }, this);
    }

    function update ()
    {
        onladder = false;
        onBodypart = false;
        isPlayerDead = false;
        //anything needing to be done to body parts goes here
        bodyparts.children.each(function(part) {
            //don't reset steppedon right away if it just got crushed or it won't fall
            if (part.squished != undefined && part.squished == false)
                part.steppedOn = false;
            //this is a janky quick fix
            if (part.body.bottom == 766) {
                part.steppedOn = false;
                part.falling = false;
            }
        }, this);
        //anything needing to be done to enemies goes here
        enemies.children.each(function(enemy) {
            enemy.onladder = false;
            this.physics.overlap(enemy, ladders, checkEnemyOverlap);
        }, this);
        this.physics.overlap(player, ladders, checkoverlap);
        this.physics.overlap(player, bodyparts, checkPartOverlap);
        this.physics.overlap(player, enemies, checkPlayerDeath);
        if (!this.physics.overlap(bodyparts, bodyparts, partsOverlap)) {
            //if nothing is overlapping reset all overlaps
            bodyparts.children.each(function(part) {
                part.hasOverlapped = false;
            }, this);
        }
        moveEnemies();
        moveBodyParts();
        if (cursors.left.isDown)
        {
            player.setVelocityX(-160);
            player.anims.play('left', true);
        }
        else if (cursors.right.isDown)
        {
            player.setVelocityX(160);
            player.anims.play('right', true);
        }
        else if (cursors.up.isDown)
        {
            if (onladder == true) {
                player.setVelocityY(-160);
                player.anims.play('up', true);
            }
        }
        else if (cursors.down.isDown)
        {
            if (onladder == true) {
                player.setVelocityY(160);
                player.anims.play('down', true);
            }
        }
        else
        {
            player.setVelocityX(0);
            if (onladder) {
                player.setAccelerationY(0);
                player.setVelocityY(0);
            }
            player.anims.play('still', true);
        }
        if(isPlayerDead){
            resetGame();
        }
        //animations
        vatscreen.anims.play('bubble', true);
    }

</script>

</body>
</html>